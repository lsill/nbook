---
title: "DHCP与PXE"
date: 2023-05-08T14:33:23+08:00
draft: true
---

### 1.如何配置ip地址
- 使用net-tools
```
$ sudo ifconfig eth1 10.0.0.1/24
$ sudo ifconfig eth1 up
```

- 使用iprouter2:
```
$ sudo ip addr add 10.0.0.1/24 dev eth1
$ sudo ip link set up eth1
```
例如，旁边的机器都是 192.168.1.x，我非得配置一个 16.158.23.6，会出现什么现象呢？
不会出现任何现象，就是包发不出去呗。
在这里，源ip是16.158.23.6，目的ip是192.168.1.6，网关ip是和192.168.1.6同组的ip，假设是192.168.1.17。那么数据包发出的时候，操作系统会检查发现源ip和目标ip不是一组的，所以不用ARP喊人，因为操作系统觉得现在喊了肯定也不知道目的ip的mac地址是多少（实际上当场喊还真可以知道目的mac，因为真在旁边）。操作系统以为要出城了，就想把包发给网关。然而！网关地址和源ip也不在一个局域网里，那就开始套娃了：我想出城，就要先去找网关，我想找网关，网关和我不在一个地方，我就要先出城…… 而如果我把电脑的网关也改成16.158.23.54之类的，那操作系统就会用ARP喊人了，喊半天并没有人理会，因为附近没有ip是16.158.23.54的网关，自然没人会回复你它的mac地址，你也没法找到这个假想的网关

Linux 首先会判断，要去的这个地址和我是一个网段的吗，或者和我的一个网卡是同一网段的吗？只有是一个网段的，它才会发送 ARP 请求，获取 MAC 地址。如果发现不是呢？
Linux 默认的逻辑是，如果这是一个跨网段的调用，它便不会直接将包发送到网络上，而是企图将包发送到网关。

如果配置了网关的话，Linux 会获取网关的 MAC 地址，然后将包发出去。

### 2.DHCP 动态主机配置协议
如果是数据中心里面的服务器，IP 一旦配置好，基本不会变，这就相当于买房自己装修。DHCP 的方式就相当于租房。你不用装修，都是帮你配置好的。你暂时用一下，用完退租就可以了。

1、广播地址：一种是直接广播地址，一种是受限广播地址 
2、受限广播地址是32位全1的IP地址(255.255.255.255) 
3、直接广播地址是网络号+全1主机号 
4、在任何情况下，路由器都不转发目的地址为受限的广播地址的数据报，这样的数据报仅出现在本地网络中

四步： 
1.客户端发出ip请求广播； 
2.多个 DHCP server 收到广播后，发出ip分配广播； 
3.客户端接收 DHCP server 的广播（一般是第一个），发出Request 广播（包中包含客户端的 MAC 地址、接受的租约中的 IP 地址、提供此租约的 DHCP 服务器地址等）； 
4.成功的 DHCP Server 接收到 DHCP request 之后，会广播返回给客户机一个 DHCP ACK 消息包。其他所有失败的 DHCP server 接收到 DHCP request 之后，解放已分配的ip。

#### 1.IP 地址的收回和续租
客户机会在租期过去 50% 的时候，直接向为其提供 IP 地址的 DHCP Server 发送 DHCP request 消息包。客户机接收到该服务器回应的 DHCP ACK 消息包，会根据包中所提供的新的租期以及其他已经更新的 TCP/IP 参数，更新自己的配置。这样，IP 租用更新就完成了。

### 3.预启动执行环境（PXE）
普通的笔记本电脑，一般不会有这种需求。因为你拿到电脑时，就已经有操作系统了，即便你自己重装操作系统，也不是很麻烦的事情。但是，在数据中心里就不一样了。数据中心里面的管理员可能一下子就拿到几百台空的机器，一个个安装操作系统，会累死的。

首先，启动 BIOS。这是一个特别小的小系统，只能干特别小的一件事情。其实就是读取硬盘的 MBR 启动扇区，将 GRUB 启动起来；然后将权力交给 GRUB，GRUB 加载内核、加载作为根文件系统的 initramfs 文件；然后将权力交给内核；最后内核启动，初始化整个操作系统。（主引导记录（MBR，Master Boot Record）是装有Linux系统的硬盘的第一个扇区，即C/H/S地址的0柱面0磁头1扇区.）
那我们安装操作系统的过程，只能插在 BIOS 启动之后了。因为没安装系统之前，连启动扇区都没有。因而这个过程叫做预启动执行环境（Pre-boot Execution Environment），简称 PXE。
首先，PXE 客户端自己也需要有个 IP 地址。因为 PXE 的客户端启动起来，就可以发送一个 DHCP 的请求，让 DHCP Server 给它分配一个地址。PXE 客户端有了自己的地址，那它怎么知道 PXE 服务器在哪里呢？对于其他的协议，都好办，要有人告诉他。例如，告诉浏览器要访问的 IP 地址，或者在配置中告诉它；例如，微服务之间的相互调用。
但是 PXE 客户端启动的时候，啥都没有。好在 DHCP Server 除了分配 IP 地址以外，还可以做一些其他的事情。这里有一个 DHCP Server 的一个样例配置：
```
ddns-update-style interim;
ignore client-updates;
allow booting;
allow bootp;
subnet 192.168.1.0 netmask 255.255.255.0
{
option routers 192.168.1.1;
option subnet-mask 255.255.255.0;
option time-offset -18000;
default-lease-time 21600;
max-lease-time 43200;
range dynamic-bootp 192.168.1.240 192.168.1.250;
filename "pxelinux.0";
next-server 192.168.1.180;
}
```
按照上面的原理，默认的 DHCP Server 是需要配置的，无非是我们配置 IP 的时候所需要的 IP 地址段、子网掩码、网关地址、租期等。如果想使用 PXE，则需要配置 next-server，指向 PXE 服务器的地址，另外要配置初始启动文件 filename。
这样 PXE 客户端启动之后，发送 DHCP 请求之后，除了能得到一个 IP 地址，还可以知道 PXE 服务器在哪里，也可以知道如何从 PXE 服务器上下载某个文件，去初始化操作系统。
- ddns-update-style interim：动态dns的更新方式 
- ignore client-updates: 忽略客户端更新 
- subnet 192.168.134.0 netmask 255.255.255.0：子网信息，定义IP地址池，可以分配多个 
- option routers：默认网关地址 
- option subnet-mask：子网掩码 
- option domain-name：域名，搜索域 
- option domain-name-servers：dns服务器地址，多个使用“,”隔开，对于linux而言最多三个 
- range: 指定地址池可分配地址范围 
- default-lease-time：默认租约长度 
- max-lease-time：最大租约长度 
- host：定义保留地址

---
title: "非阻塞IO"
date: 2024-03-13T16:21:13+08:00
draft: true
---

## 1. 概述
套接字的默认状态是阻塞的。这就意味者当发出一个不能立即完成的套接字调用时，其进程将被投入睡眠，
等待相应操作完成。可能阻塞的套接字调用可分为以下四类。

(1)输入操作，包括read、readv、recv、recvfrom和recvmsg共5个函数。如果某个进程对一个阻塞
的TCP套接字(默认设置)调用这些输入函数之一，而且该套接字的接收缓冲区中没有数据可读，该进程将
被投入睡眠，直到有一些数据到达。既然TCP是字节流协议，该进程的唤醒就是只要有一些数据到达，这
些数据既可能是单个字节，也可以是一个完整的TCP分节中的数据。如果想等到某个固定数目的数据可读
为止，那么可以调用我们的readn函数，或者指定MSG_WAITALL标志。

既然UDP是数据报协议，如果一个阻塞的UDP套接字的接收缓冲区为空，对它调用输入函数的进程将被投
入睡眠，直到有UDP数据报到达。

对于非阻塞的套接字，如果输入操作不能被满足(对于TCP套接字即至少有一个字节的数据可读，对于UDP
套接字即有一个完整的数据报可读)，相应调用将立即返回一个EMOULDBLOCK错误。

(2)输出操作，包括write、writev、send、sendto和sendmsg共5个函数。对于一个TCP套接字，内核
将从应用进程的缓冲区到该套接字的发送缓冲区复制数据。对于阻塞的套接字，如果其发送缓冲区中没有空
间，进程将被投入睡眠，直到有空间为止。

对于一个非阻塞的TCP套接字，如果其发送缓冲区中根本没有空间，输出函数调用将立即返回一个EWOULDBLOCK
错误。如果其发送缓冲区中有一些空间，返回值将是内核能够复制到该缓冲区中的字节数。这个字节数也称为不
足计數(short count)。

UDP套接字不存在真正的发送缓冲区。内核只是复制应用进程数据并把它沿协议栈向下传送，渐次冠以UDP首部和
IP首部。因此对一个阻塞的UDP套接字(默认设置)，输出函数调用将不会因与TCP套接字一样的原因而阻塞，不
过有可能会因其他的原因而阻塞。

(3)接受外来连接，即accept函数。如果对一个阻塞的套接字调用accept函数，并且尚无新的连接到达，调用进程
将被投入睡眠。

如果对一个非阻塞的套接字调用accept函数，并且尚无新的连接到达，accept调用将立即返回一个ENOULDBIOCK错误。

(4)发起外出连接，即用于TCP的connect函数。connect同样可用于UDP，不过它不能使一个“真正”的连接建立起来，
它只是使内核保存对端的IP地址和端口号。TCP连接的建立涉及一个三路握手过程，而且connect函数一直要等到客户
收到对于自己的SYN的ACK为止才返回。这意味着TCP的每个connect总会阻塞其调用进程至少一个到服务器的RTT时间。

如果对一个非阻塞的TCP套接字调用connect，并且连接不能立即建立，那么连接的建立能照样发起(臂如送出TCP三路
握手的第一个分组)，不过会返回一个EINPROGRESS错误。注意这个错误不同与上述三个情形中返回的错误。另请注意
有些连接可以立即建立，通常发生在服务器和客户处于同一个主机的情况下。因此即使对于一个非阻塞的connect，我
们也得预备connect成功返回的情况发生。













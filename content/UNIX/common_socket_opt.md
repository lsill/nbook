---
title: "通用套接字选项"
date: 2023-12-25T18:43:23+08:00
draft: true
---

## SO_BROADCAST套接字选项
(broadcast)

本选项开启或禁止进程发送广播消息的能力。只有数据报套接字支持广播，并且还必须是在支持广播消息的网络上(例如以太网、令牌环网等)。
我们不可能在点对点链路上进行广播，也不可能在基于连接的传输协议(例如TCP和SCTP)之上进行广播。

由于应用进程在发送广播数据报之前必须设置本套接字选项，因此它能够有效地防止一个进程在其应用程序根本没有设计成可广播时就发送广播
数据报。举例来说，一个UDP应用程序可能以命令行参数的形式取得目的IP地址，不过它并不期望用户键入一个广播地址。处理方法并非让应用
进程来确定一个给定地址是否为广播地址，而是在内核中进行测试:如果该目的地址是一个广播地址且本套接字选项没有设置，那么返回
EACCES错误。

## SO_DEBUG套接字选项
(debug)

本选项仅由TCP支持。当给一个TCP套接字开启本选项时，内核将为TCP在该套接字发送和接收的所有分组保留详细跟踪信息。这些信息保存在内核
的某个环形缓冲区中，并可使用trpt程序进行检查。

## SO_DONTROUTE
(don't route)

本选项规定外出的分组将绕过底层协议的正常路由机制。举例来说，在IPV4情况下外出分组将被定向到适当的本地接口，也就是由其目的地址的
网络和子网部分确定的本地接口。如果这样的本地接口无法由目的地址确定(臂如说目的地主机不在一个点对点链路的另一端，也不在一个共享的
网络上)，那么返回ENETUNREACH错误。

给函数send、sendto或sendmsg使用MSG_DONTROUTE标志也能在个别的数据报上取得与本选项相同的效果。

路由守护进程(routed和gated)经常使用本选项来绕过路由表(路由表不正确的情况下)，以强制將分组从特定接口送出。

## SO_ERROR 套接字选项
当一个套接字上发生错误时，源自Berkcley的内核中的协议模块将该套接宇的名为so_error的变量设为标准的Unix Exxx值中的一个，
我们称它为该套接字的待处理错误(pending error)。内核能够以下面两种方式之一立即通知进程这个错误。
(1)如果进程阻塞在对该套接字的select调用上，那么无论是检查可读条件还是可写条件，select均返回并设置其中一个或所有两个条件。
(2)如果进程使用信号驱动式I/O模型，那就给进程或进程组产生一个SIGIO信号。

进程然后可以通过访问SO_ERROR套接字选项获取so_error的值。由getsockopt返回的整数值就是该套接字的待处理错误。
so_error随后由内核复位为0。

当进程调用read且没有数据返回时，如果so_error为非0值，那么read返回-1且errno被置为so_error的值。so_error随后被复位为0。
如果该套接字上有数据在排队等待读取，那么read返回那此数据而不是返回错误条件。如果在进程调用write时so_error为非0值，那么
write返回-1且errno被设为so_error的值。so_error随后被复位为0。

## SO_KEEPALIVE 套接字选项
(keep alive)

给一个TCP套接字设置保持存活(keep-alive)选项后，如果2小时内在该套接字的任一方向上都没有数据交换，TCP就自动给对端发送一个
保持存活探测分节(keep-alive probe)。这是一个对端必须响应的TCP分节，它会导致以下三种情况之一。

(1)对端以期望的ACK响应。应用进程得不到通知(因为一切正常)。在又经过仍无动静的2小时后，TCP将发出另一个探测分节。

(2)对端以RST响应，它告知本端TCP:对瑞已崩溃且己重新启动。该套接字的待处理错误被置为ECONNRESET，套接字本身则被关闭。

(3)对端对保持存活探测分节没有任何响应。源自Berkeley的TCP将另外发送8个探测分节，两两相隔75秒，试图得到一个响应。
TCP在发出第一个探测分节后11分15秒内若没有得到任何啊应则放弃。

如果根本没有对TCP的探测分节的响应，该套接字的待处理错误就被置为ETIMEOUT，套接字本身则被关闭。然而如果该套接字收到一个
ICMP错误作为某个探测分节的响应，那就返回相应的错误，套接字本身也被关闭。这种情形下一个常见的ICMP错误是“host unreachable”
〈主机不可达)，说明对端主机可能并没有崩溃，只是不可达，这种情况下待处理错误被置为EHOSTUNREACH。发生这种情况的原因或者是发
生网络故障，或者是对端主机己经崩溃，而最后一跳的路由器也己经检测到它的崩溃。

对于本选项的一个最常见的问题无疑是时间参数是否可改(通常是想把2小时的无活动周期改为短些的值)。大多数内核是基于整个内核维护这些
时间参数的，而不是基于每个套接字维护的，因此如果把无活动周期从2小时改为(臂如说)15分钟，那将影响到该主机上所有开启了本选项的套
接字。然而这些问题通常是由对本选项功用的误解导致的。

本选项的功用是检测对端主机是否崩溃或变得不可达(臂如拨号调制解调器连接掉线，电源发生故障，等等)。如果对端进程崩溃，它的TCP将跨
连接发送一个FIN，这可以通过调用select很容易地检测到。同时也要认识到，即使对任何保持存活探测分节均无响应(第三种情况)，我们也
不能肯定对端主机已经崩溃，因而TCP可能会终止一个有效连接。某个中间路由器崩溃15分钟是有可能的，而这段时间正好与主机的11分15秒的
保持存活探测周期完全重迭。事实上本功能称为“切断”(make-dead)而不是“保持存活〞也许更合适些，因为它可能终止存活的连接。

本选项一般由服务器使用，不过客户也可以使用。服务器使用本选项是因为它们花大部分时间阻塞在等待穿越TCP连接的输入上，也就是说在等
待客户的请求。然而如果容户主机连接掉线、电源掉电或系统崩溃，服务器进程将永远不会知道，并将继续等待永远不会到达的输入。我们称这
种情况为半开连接(half-open connection)。保持存活选项将检测出这些半开连接并终止它们。

有些服务器(特別是FTP服务器)提供一个分钟量级的应用层超时。这足由应用进程本身完成的，一般在读下一个客户命令的read调用附近。这个
超时与本套接字选项无关。这通常是清理通向不可达客户的半开连接的较好办法，因为如果应用系统自己实现超时，应用进程就具备完全的控制能力。








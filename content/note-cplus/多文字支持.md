---
title: "Unicodeï¼šè¿›å…¥å¤šæ–‡å­—æ”¯æŒçš„ä¸–ç•Œ"
date: 2023-02-28T16:05:45+18:00
draft: true
---

**ç°ä»£C++å®æˆ˜30è®²ç¬”è®°**

### Unicodeç®€ä»‹
Unicode åœ¨ä»Šå¤©å·²ç»å¤§å¤§è¶…å‡ºäº†æœ€åˆçš„ç›®æ ‡ã€‚åˆ° Unicode 12.1 ä¸ºæ­¢ï¼ŒUnicode å·²ç»åŒ…å«äº† 137,994 ä¸ªå­—ç¬¦ï¼Œå›Šæ‹¬æ‰€æœ‰ä¸»è¦è¯­è¨€ï¼ˆä½¿ç”¨ä¸­çš„å’Œå·²ç»ä¸å†ä½¿ç”¨çš„ï¼‰ï¼Œå¹¶åŒ…å«äº†è¡¨æƒ…ç¬¦å·ã€æ•°å­¦ç¬¦å·ç­‰å„ç§ç‰¹æ®Šå­—ç¬¦ã€‚ä»ç„¶è¦æŒ‡å‡ºä¸€ä¸‹ï¼ŒUnicode å­—ç¬¦æ˜¯æ ¹æ®å«ä¹‰æ¥åŒºåˆ†çš„ï¼Œè€Œéæ ¹æ®å­—å½¢ã€‚é™¤äº†å‰é¢æåˆ°è¿‡ä¸­æ—¥éŸ©æ±‰å­—æ²¡æœ‰åˆ†å¼€ï¼Œåƒæ–œä½“ï¼ˆitalicsï¼‰ã€å°å¤§å†™å­—æ¯ï¼ˆsmall capsï¼‰ç­‰æ’ç‰ˆæ•ˆæœåœ¨ Unicode é‡Œä¹Ÿæ²¡æœ‰ç‹¬ç«‹çš„å¯¹åº”ã€‚ä¸è¿‡ï¼Œå› ä¸º Unicode é‡ŒåŒ…å«äº†å¾ˆå¤šæ•°å­¦ã€ç‰©ç†ç­‰è‡ªç„¶ç§‘å­¦ä¸­ä½¿ç”¨çš„ç‰¹æ®Šç¬¦å·ï¼ŒæŸäº›æƒ…å†µä¸‹ä½ ä¹Ÿå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ç¬¦å·ï¼Œå¯ä»¥ç”¨åœ¨èŠå¤©ä¸­è€é…·ï¼Œå¦‚ ğ’·ğ’¶ğ’¹ï¼ˆä½†ä¸é€‚åˆä¸¥è‚ƒçš„æ’ç‰ˆï¼‰ã€‚

Unicode çš„ç¼–ç ç‚¹æ˜¯ä» 0x0 åˆ° 0x10FFFFï¼Œä¸€å…± 1,114,112 ä¸ªä½ç½®ã€‚ä¸€èˆ¬ç”¨â€œU+â€åé¢è·Ÿ 16 è¿›åˆ¶çš„æ•°å€¼æ¥è¡¨ç¤ºä¸€ä¸ª Unicode å­—ç¬¦ï¼Œå¦‚ U+0020 è¡¨ç¤ºç©ºæ ¼ï¼ŒU+6C49 è¡¨ç¤ºâ€œæ±‰â€ï¼ŒU+1F600 è¡¨ç¤ºâ€œğŸ˜€â€ï¼Œç­‰ç­‰ï¼ˆä¸è¶³å››ä½çš„ä¸€èˆ¬å†™å››ä½ï¼‰ã€‚

Unicode å­—ç¬¦çš„å¸¸è§ç¼–ç æ–¹å¼æœ‰ï¼š

- UTF-32ï¼š32 æ¯”ç‰¹ï¼Œæ˜¯ç¼–ç ç‚¹çš„ç›´æ¥æ˜ å°„ã€‚
- UTF-16ï¼šå¯¹äºä» U+0000 åˆ° U+FFFF çš„å­—ç¬¦ï¼Œä½¿ç”¨ 16 æ¯”ç‰¹çš„ç›´æ¥æ˜ å°„ï¼›å¯¹äºå¤§äº U+FFFF çš„å­—ç¬¦ï¼Œä½¿ç”¨ 32 æ¯”ç‰¹çš„ç‰¹æ®Šæ˜ å°„å…³ç³»â€”â€”åœ¨ Unicode çš„ 16 æ¯”ç‰¹ç¼–ç ç‚¹ä¸­ 0xD800â€“0xDFFF æ˜¯ä¸€æ®µç©ºéš™ï¼Œä½¿å¾—è¿™ç§å˜é•¿ç¼–ç æˆä¸ºå¯èƒ½ã€‚åœ¨ä¸€ä¸ª UTF-16 çš„åºåˆ—ä¸­ï¼Œå¦‚æœçœ‹åˆ°å†…å®¹æ˜¯ 0xD800â€“0xDBFFï¼Œé‚£è¿™å°±æ˜¯ 32 æ¯”ç‰¹ç¼–ç çš„å‰ 16 æ¯”ç‰¹ï¼›å¦‚æœçœ‹åˆ°å†…å®¹æ˜¯ 0xDC00â€“0xDFFFï¼Œé‚£è¿™æ˜¯ 32 æ¯”ç‰¹ç¼–ç çš„å 16 æ¯”ç‰¹ï¼›å¦‚æœå†…å®¹åœ¨ 0xD800â€“0xDFFF ä¹‹å¤–ï¼Œé‚£å°±æ˜¯ä¸€ä¸ª 16 æ¯”ç‰¹çš„æ˜ å°„ã€‚
- UTF-8 ï¼š1 åˆ° 4 å­—èŠ‚çš„å˜é•¿ç¼–ç ã€‚åœ¨ä¸€ä¸ªåˆæ³•çš„ UTF-8 çš„åºåˆ—ä¸­ï¼Œå¦‚æœçœ‹åˆ°ä¸€ä¸ªå­—èŠ‚çš„æœ€é«˜ä½æ˜¯ 0ï¼Œé‚£å°±æ˜¯ä¸€ä¸ªå•å­—èŠ‚çš„ Unicode å­—ç¬¦ï¼›å¦‚æœä¸€ä¸ªå­—èŠ‚çš„æœ€é«˜ä¸¤æ¯”ç‰¹æ˜¯ 10ï¼Œé‚£è¿™æ˜¯ä¸€ä¸ª Unicode å­—ç¬¦åœ¨ç¼–ç åçš„åç»­å­—èŠ‚ï¼›å¦åˆ™ï¼Œè¿™å°±æ˜¯ä¸€ä¸ª Unicode å­—ç¬¦åœ¨ç¼–ç åçš„é¦–å­—èŠ‚ï¼Œä¸”æœ€é«˜ä½å¼€å§‹è¿ç»­ 1 çš„ä¸ªæ•°è¡¨ç¤ºäº†è¿™ä¸ªå­—ç¬¦æŒ‰ UTF-8 çš„æ–¹å¼ç¼–ç æœ‰å‡ ä¸ªå­—èŠ‚ã€‚

åœ¨ä¸Šé¢ä¸‰ç§ç¼–ç æ–¹å¼é‡Œï¼Œåªæœ‰ UTF-8 å®Œå…¨ä¿æŒäº†å’Œ ASCII çš„å…¼å®¹æ€§ï¼Œç›®å‰å¾—åˆ°äº†æœ€å¹¿æ³›çš„ä½¿ç”¨ã€‚åœ¨æˆ‘ä»¬ä¸‹é¢è®²å…·ä½“ç¼–ç æ–¹å¼ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä¸Šé¢æåˆ°çš„ä¸‰ä¸ªå­—ç¬¦åœ¨è¿™ä¸‰ç§æ–¹å¼ä¸‹çš„ç¼–ç ç»“æœï¼š
- UTF-32ï¼šU+0020 æ˜ å°„ä¸º 0x00000020ï¼ŒU+6C49 æ˜ å°„ä¸º 0x00006C49ï¼ŒU+1F600 æ˜ å°„ä¸º 0x0001F600ã€‚
- UTF-16ï¼šU+0020 æ˜ å°„ä¸º 0x0020ï¼ŒU+6C49 æ˜ å°„ä¸º 0x6C49ï¼Œè€Œ U+1F600 ä¼šæ˜ å°„ä¸º 0xD83D DE00ã€‚
- UTF-8ï¼šU+0020 æ˜ å°„ä¸º 0x20ï¼ŒU+6C49 æ˜ å°„ä¸º 0xE6 B1 89ï¼Œè€Œ U+1F600 ä¼šæ˜ å°„ä¸º 0xF0 9F 98 80ã€‚

Unicode æœ‰å¥½å‡ ç§ï¼ˆä¸Šé¢è¿˜ä¸æ˜¯å…¨éƒ¨ï¼‰ä¸åŒçš„ç¼–ç æ–¹å¼ï¼Œä¸Šé¢çš„ 16 æ¯”ç‰¹å’Œ 32 æ¯”ç‰¹ç¼–ç æ–¹å¼è¿˜æœ‰å°å¤´å…šå’Œå¤§å¤´å…šä¹‹äº‰ï¼ˆâ€œæ±‰â€æŒ‰å­—èŠ‚è¯»å–æ—¶æ˜¯ 6C 49 å‘¢ï¼Œè¿˜æ˜¯ 49 6Cï¼Ÿï¼‰ï¼›åŒæ—¶ï¼Œä»»ä½•ä¸€ç§ç¼–ç æ–¹å¼è¿˜éœ€è¦è·Ÿä¼ ç»Ÿçš„ç¼–ç æ–¹å¼å®¹æ˜“åŒºåˆ†ã€‚å› æ­¤ï¼ŒUnicode æ–‡æœ¬æ–‡ä»¶é€šå¸¸æœ‰ä¸€ä¸ªä½¿ç”¨ BOMï¼ˆbyte order markï¼‰å­—ç¬¦çš„çº¦å®šï¼Œå³å­—ç¬¦ U+FEFF ã€‚ç”±äº Unicode ä¸ä½¿ç”¨ U+FFFEï¼Œåœ¨æ–‡ä»¶å¼€å¤´åŠ ä¸€ä¸ª BOM å³å¯åŒºåˆ†å„ç§ä¸åŒç¼–ç ï¼š
- å¦‚æœæ–‡ä»¶å¼€å¤´æ˜¯0x00 00 FE FFï¼Œé‚£è¿™æ˜¯å¤§å¤´åœ¨å‰çš„UTF-32ç¼–ç ï¼›
- å¦åˆ™å¦‚æœæ–‡ä»¶å¼€å¤´æ˜¯0xFF FE 00 00,é‚£è¿™æ˜¯å°å¤´åœ¨å‰çš„UTF-32ç¼–ç ï¼›
- å¦åˆ™å¦‚æœæ–‡ä»¶å¼€å¤´æ˜¯0xFE FF,é‚£è¿™æ˜¯å¤§å¤´åœ¨å‰çš„ UTF-16 ç¼–ç ï¼›
- å¦åˆ™å¦‚æœæ–‡ä»¶å¼€å¤´æ˜¯ 0xFF FEï¼Œé‚£è¿™æ˜¯å°å¤´åœ¨å‰çš„ UTF-16 ç¼–ç ï¼ˆæ³¨æ„ï¼Œè¿™æ¡è§„åˆ™å’Œç¬¬äºŒæ¡çš„é¡ºåºä¸èƒ½ç›¸åï¼‰ï¼›
- å¦åˆ™å¦‚æœæ–‡ä»¶å¼€å¤´æ˜¯0xEF BB BF,é‚£è¿™æ˜¯ UTF-8 ç¼–ç ï¼›
- å¦åˆ™ï¼Œç¼–ç æ–¹å¼ä½¿ç”¨å…¶ä»–ç®—æ³•æ¥ç¡®å®šã€‚

ç¼–è¾‘å™¨å¯ä»¥ï¼ˆæœ‰äº›åœ¨é…ç½®ä¹‹åï¼‰æ ¹æ® BOM å­—ç¬¦æ¥è‡ªåŠ¨å†³å®šæ–‡æœ¬æ–‡ä»¶çš„ç¼–ç ã€‚æ¯”å¦‚ï¼Œä¸€èˆ¬åœ¨ Vim ä¸­é…ç½® set fileencodings=ucs-bom,utf-8,gbk,latin1ã€‚è¿™æ ·ï¼ŒVim åœ¨è¯»å…¥æ–‡ä»¶æ—¶ï¼Œä¼šé¦–å…ˆæ£€æŸ¥ BOM å­—ç¬¦ï¼Œæœ‰ BOM å­—ç¬¦æŒ‰ BOM å­—ç¬¦å†³å®šæ–‡ä»¶ç¼–ç ï¼›å¦åˆ™ï¼Œè¯•å›¾å°†æ–‡ä»¶æŒ‰ UTF-8 æ¥è§£ç ï¼ˆç”±äº UTF-8 æœ‰æ ¼å¼è¦æ±‚ï¼Œé UTF-8 ç¼–ç çš„æ–‡ä»¶é€šå¸¸ä¼šå¯¼è‡´å¤±è´¥ï¼‰ï¼›ä¸è¡Œï¼Œåˆ™è¯•å›¾æŒ‰ GBK æ¥è§£ç ï¼ˆå¤±è´¥çš„æ¦‚ç‡å°±å¾ˆä½äº†ï¼‰ï¼›è¿˜ä¸è¡Œï¼Œå°±æŠŠæ–‡ä»¶å½“ä½œ Latin1 æ¥å¤„ç†ï¼ˆæ°¸è¿œä¸ä¼šå¤±è´¥ï¼‰ã€‚
åœ¨ UTF-8 ç¼–ç ä¸‹ä½¿ç”¨ BOM å­—ç¬¦å¹¶éå¿…éœ€ï¼Œå°¤å…¶åœ¨ Unix ä¸Šã€‚ä½† Windows ä¸Šé€šå¸¸ä¼šä½¿ç”¨ BOM å­—ç¬¦ï¼Œä»¥æ–¹ä¾¿åŒºåˆ† UTF-8 å’Œä¼ ç»Ÿç¼–ç ã€‚

### C++ä¸­çš„Unicodeå­—ç¬¦ç±»å‹
C++98ä¸­æœ‰charå’Œwchar_tä¸¤ç§ä¸åŒçš„å­—ç¬¦ç±»å‹ï¼Œå…¶ä¸­charçš„é•¿åº¦æ˜¯å•å­—èŠ‚ï¼Œè€Œwchar_tçš„é•¿åº¦ä¸ç¡®å®šã€‚åœ¨ Windows ä¸Šå®ƒæ˜¯åŒå­—èŠ‚ï¼Œåªèƒ½ä»£è¡¨ UTF-16ï¼Œè€Œåœ¨ Unix ä¸Šä¸€èˆ¬æ˜¯å››å­—èŠ‚ï¼Œå¯ä»¥ä»£è¡¨ UTF-32ã€‚ä¸ºäº†è§£å†³è¿™ç§æ··ä¹±ï¼Œç›®å‰æœ‰äº†ä¸‹é¢çš„æ”¹è¿›ï¼š
- C++11å¼•å…¥äº†char_16_tå’Œchar32_tä¸¤ä¸ªç‹¬ç«‹çš„å­—ç¬¦ç±»å‹ï¼ˆä¸æ˜¯ç±»å‹åˆ«åï¼‰ï¼Œåˆ†åˆ«ä»£è¡¨UTF-16å’ŒUTF-32ã€‚
- C++20å°†å¼•å…¥char8_tç±»å‹ï¼Œæ¥è¿›ä¸€æ­¥åŒºåˆ†äº†å¯èƒ½ä½¿ç”¨ä¼ ç»Ÿç¼–ç çš„çª„å­—ç¬¦ç±»å‹å’ŒUTF-8å­—ç¬¦ç±»å‹ã€‚
- é™¤äº†stringå’Œwstringï¼Œä¹Ÿç›¸åº”åœ°åˆäº†u16stringã€u32stringï¼ˆå’Œå°†æ¥çš„u8stringï¼‰ã€‚
- é™¤äº†ä¼ ç»Ÿçš„çª„å­—ç¬¦/å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆå¦‚â€œhiâ€ï¼‰å’Œå®½å­—ç¬¦/å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆå¦‚L"hi"ï¼‰ï¼Œå¼•å…¥äº†æ–°çš„UTF-8ã€UTF-16 å’Œ UTF-32 å­—é¢é‡ï¼Œåˆ†åˆ«å½¢å¦‚ u8"hi"ã€u"hi" å’Œ U"hi"ã€‚
- ä¸ºäº†ç¡®ä¿ASCLLå­—ç¬¦åœ¨æºä»£ç ä¸­å¯ä»¥ç®€å•çš„è¾“å…¥ï¼Œå¼•å…¥äº†æ–°çš„Unicodeæ¢ç åºåˆ—ã€‚æ¯”å¦‚ï¼Œå‰é¢è¯´åˆ°çš„ä¸‰ä¸ªå­—ç¬¦å¯ä»¥è¿™æ ·è¡¨è¾¾æˆä¸€ä¸ª UTF-32 å­—ç¬¦ä¸²å­—é¢é‡ï¼šU" \u6C49\U0001F600"ã€‚è¦ç”Ÿæˆ UTF-16 æˆ– UTF-8 å­—ç¬¦ä¸²å­—é¢é‡åªéœ€è¦æ›´æ”¹å‰ç¼€å³å¯ã€‚

ä½¿ç”¨è¿™äº›æ–°çš„å­—ç¬¦ï¼ˆä¸²ï¼‰ç±»å‹ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç è¡¨è¾¾å‡º UTF-32 å’Œå…¶ä»–ä¸¤ç§ UTF ç¼–ç é—´æ˜¯å¦‚ä½•è½¬æ¢çš„ï¼š
```c++
const char32_t unicode_max = 0x10FFFF;

void to_utf_16(char32_t ch, std::u16string& result) {
  if (ch > unicode_max) {
    throw std::runtime_error("invalid code point");
  }
  if (ch < 0x10000) {
    result += char16_t(ch);
  } else {
    char16_t first = 0xD800 | ((ch - 0x10000) >> 10);
    char16_t second = 0xDC00 | (ch & 0x3FF);
    result += first;
    result += second;
  }
}

void to_utf_8(char32_t ch, std::string& result) {
  if (ch > unicode_max) {
    throw std::runtime_error("invalid code point");
  }
  if (ch < 0x80) {
    result += ch;
  } else if (ch < 0x800) {
    result += 0xC0 | (ch >> 6);
    result += 0x80 | (ch & 0x3F);
  } else if (ch < 0x10000) {
    result += 0xE0 | (ch >> 12);
    result += 0x80 | ((ch >> 6) & 0x3F);
  } else {
    result += 0xF0 | (ch >> 18);
    result += 0x80 | ((ch >> 12) & 0x3F);
    result += 0x80 | ((ch >> 6) & 0x3F);
    result += 0x80 | (ch & 0x3F);
  }
}

int main() {
  char32_t str[] = U" \u6C49\U0001F600";
  std::u16string u16str;
  std::string u8str;
  for (auto ch : str) {
    if (ch == 0) {
      break ;
    }
    to_utf_16(ch, u16str);
    to_utf_8(ch, u8str);
  }
  std::cout<< std::hex << std::setfill('0');
  for (char16_t  ch : u16str) {
    std::cout << std::setw(4) << unsigned(ch) << ' ';
  }
  std::cout << std::endl;
  for (unsigned char ch : u8str) {
    std::cout<< std::setw(2) << unsigned(ch) << ' ';
  }
  std::cout<<std::endl;
}

```
è¾“å‡ºçš„ç»“æœæ˜¯ï¼š
```
0020 6c49 d83d de00 
20 e6 b1 f0 9f 98 80 
```

### å¹³å°åŒºåˆ«
#### UNIX
ç°ä»£ Unix ç³»ç»Ÿï¼ŒåŒ…æ‹¬ Linux å’Œ macOS åœ¨å†…ï¼Œå·²ç»å…¨é¢è½¬å‘äº† UTF-8ã€‚è¿™æ ·çš„ç³»ç»Ÿä¸­ä¸€èˆ¬ç›´æ¥ä½¿ç”¨ char[] å’Œ string æ¥ä»£è¡¨ UTF-8 å­—ç¬¦ä¸²ï¼ŒåŒ…æ‹¬è¾“å…¥ã€è¾“å‡ºå’Œæ–‡ä»¶åï¼Œéå¸¸ç®€å•ã€‚ä¸è¿‡ï¼Œç”±äºä¸€ä¸ªå­—ç¬¦å•ä½ä¸èƒ½ä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„ Unicode å­—ç¬¦ï¼Œåœ¨éœ€è¦çœŸæ­£è¿›è¡Œæ–‡å­—å¤„ç†çš„åœºåˆè½¬æ¢åˆ° UTF-32 å¾€å¾€ä¼šæ›´ç®€å•ã€‚åœ¨ä»¥å‰åŠéœ€è¦å’Œ C å…¼å®¹çš„åœºåˆï¼Œä¼šä½¿ç”¨ wchar_tã€uint32_t æˆ–æŸä¸ªç­‰ä»·çš„ç±»å‹åˆ«åï¼›åœ¨æ–°çš„çº¯ C++ ä»£ç é‡Œï¼Œå°±æ²¡æœ‰ç†ç”±ä¸ä½¿ç”¨ char32_t å’Œ u32string äº†ã€‚

Unix ä¸‹è¾“å‡ºå®½å­—ç¬¦ä¸²éœ€è¦ä½¿ç”¨ wcoutï¼ˆè¿™ç‚¹å’Œ Windows ç›¸åŒï¼‰ï¼Œå¹¶ä¸”éœ€è¦è¿›è¡ŒåŒºåŸŸè®¾ç½®ï¼Œé€šå¸¸ä½¿ç”¨ setlocale(LC_ALL, "en_US.UTF-8"); å³è¶³å¤Ÿã€‚ç”±äºæ²¡æœ‰ä»€ä¹ˆé¢å¤–å¥½å¤„ï¼ŒUnix å¹³å°ä¸‹ä¸€èˆ¬åªç”¨ coutï¼Œä¸ç”¨ wcoutã€‚

#### WINDOWS
Windows ç”±äºå†å²åŸå› å’Œä¿ç•™å‘åå…¼å®¹æ€§çš„éœ€è¦ï¼ˆWindows ä¸ºäº†å‘åå…¼å®¹æ€§å·²ç»åˆ°äº†å¤§è§„æ¨¡æ”¾å¼ƒä¼˜é›…çš„ç¨‹åº¦äº†ï¼‰ï¼Œä¸€ç›´ç”¨ char è¡¨ç¤ºä¼ ç»Ÿç¼–ç ï¼ˆå¦‚ï¼Œè‹±æ–‡ Windows ä¸Šæ˜¯ Windows-1252ï¼Œç®€ä½“ä¸­æ–‡ Windows ä¸Šæ˜¯ GBKï¼‰ï¼Œç”¨ wchar_t è¡¨ç¤º UTF-16ã€‚ç”±äºä¼ ç»Ÿç¼–ç ä¸€æ¬¡åªæœ‰ä¸€ç§ã€ä¸”éœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆï¼Œè¦å¾—åˆ°å¥½çš„å¤šè¯­è¨€æ”¯æŒï¼Œåœ¨å’Œæ“ä½œç³»ç»Ÿäº¤äº’æ—¶å¿…é¡»ä½¿ç”¨ UTF-16ã€‚

å¯¹äºçº¯ Windows ç¼–ç¨‹ï¼Œå…¨é¢ä½¿ç”¨å®½å­—ç¬¦ï¼ˆä¸²ï¼‰æ˜¯æœ€ç®€å•çš„å¤„ç†æ–¹å¼ã€‚å½“ç„¶ï¼Œæºä»£ç å’Œæ–‡æœ¬å¾ˆå°‘ç”¨ UTF-16 å­˜å‚¨ï¼Œé€šå¸¸è¿˜æ˜¯ UTF-8ï¼ˆé™¤éæ˜¯çº¯ ASCIIï¼Œå¦åˆ™éœ€è¦åŠ å…¥ BOM å­—ç¬¦æ¥å’Œä¼ ç»Ÿç¼–ç ç›¸åŒºåˆ†ï¼‰ã€‚è¿™æ—¶å¯èƒ½ä¼šæœ‰ä¸€ä¸ªå°å°çš„ä»¤äººæƒŠè®¶çš„åœ°æ–¹ï¼šå¾®è½¯çš„ç¼–è¯‘å™¨ä¼šæŠŠæºä»£ç é‡Œçª„å­—ç¬¦ä¸²å­—é¢é‡ä¸­çš„é ASCII å­—ç¬¦è½¬æ¢æˆä¼ ç»Ÿç¼–ç ã€‚æ¢å¥è¯è¯´ï¼ŒåŒæ ·çš„æºä»£ç åœ¨ä¸åŒç¼–ç çš„ Windows ä¸‹ç¼–è¯‘å¯èƒ½ä¼šäº§ç”Ÿä¸åŒçš„ç»“æœï¼å¦‚æœä½ å¸Œæœ›ä¿ç•™ UTF-8 åºåˆ—çš„è¯ï¼Œå°±åº”è¯¥ä½¿ç”¨ UTF-8 å­—é¢é‡ï¼ˆå¹¶åœ¨å°†æ¥ä½¿ç”¨ char8_t å­—ç¬¦ç±»å‹ï¼‰ã€‚
```c++

#include <stdio.h>
template <typename T>
void dump(const T& str)
{
  for (char ch : str) {
    printf(
      "%.2x ",
      static_cast<unsigned char>(ch));
  }
  putchar('\n');
}
int main()
{
  char str[] = "ä½ å¥½";
  char u8str[] = u8"ä½ å¥½";
  dump(str);
  dump(u8str);
}
```
ä¸‹é¢å±•ç¤ºçš„æ˜¯ä»¥ä¸Šä»£ç åœ¨ Windows ä¸‹ç³»ç»Ÿä¼ ç»Ÿç¼–ç è®¾ç½®ä¸ºç®€ä½“ä¸­æ–‡æ—¶çš„ç¼–è¯‘ã€è¿è¡Œç»“æœï¼š
```
c4 e3 ba c3 00
e4 bd a0 e5 a5 bd 00
```
Windows ä¸‹çš„ wcout ä¸»è¦ç”¨åœ¨é…åˆå®½å­—ç¬¦çš„è¾“å‡ºï¼Œæ­¤å¤–æ²¡ä»€ä¹ˆå¤§ç”¨å¤„ã€‚åŸå› ä¸€æ ·ï¼Œåªæœ‰è¿›è¡Œäº†æ­£ç¡®çš„åŒºåŸŸè®¾ç½®ï¼Œæ‰èƒ½è¾“å‡ºå«é ASCII å­—ç¬¦çš„å®½å­—ç¬¦ä¸²ã€‚å¦‚æœè¦è¾“å‡ºä¸­æ–‡ï¼Œå¾—å†™ setlocale(LC_ALL, "Chinese_China.936");ï¼Œè¿™æ˜¾ç„¶å°±è®©â€œç»Ÿä¸€ç â€è¾“å‡ºå¤±å»æ„ä¹‰äº†ã€‚
ç”±äºçª„å­—ç¬¦åœ¨å¤§éƒ¨åˆ† Windows ç³»ç»Ÿä¸Šåªæ”¯æŒä¼ ç»Ÿç¼–ç ï¼Œè¦æ‰“å¼€ä¸€ä¸ªå½“å‰ç¼–ç ä¸æ”¯æŒçš„æ–‡ä»¶åç§°ï¼Œå°±å¿…éœ€ä½¿ç”¨å®½å­—ç¬¦çš„æ–‡ä»¶åã€‚å¾®è½¯çš„ fstream ç³»åˆ—ç±»åŠå…¶ open æˆå‘˜å‡½æ•°éƒ½æ”¯æŒ const wchar_t* ç±»å‹çš„æ–‡ä»¶åï¼Œè¿™æ˜¯ C++ æ ‡å‡†é‡Œæ‰€æ²¡æœ‰çš„ã€‚

### ç»Ÿä¸€åŒ–å¤„ç†
è¦æƒ³å†™å‡ºè·¨å¹³å°çš„å¤„ç†å­—ç¬¦ä¸²çš„ä»£ç ï¼Œæˆ‘ä»¬ä¸€èˆ¬è€ƒè™‘ä¸¤ç§æ–¹å¼ä¹‹ä¸€ï¼š
- æºä»£ç çº§å…¼å®¹ï¼Œä½†å†…ç ä¸åŒ
- æºä»£ç å’Œå†…ç å®Œå…¨å…¼å®¹

å¾®è½¯æ¨èçš„æ–¹å¼ä¸€èˆ¬æ˜¯å‰è€…ã€‚åš Windows å¼€å‘çš„äººå¾ˆå¤šéƒ½çŸ¥é“ tchar.h å’Œ _T å®ï¼Œå®ƒä»¬å°±èµ·ç€ç±»ä¼¼çš„ä½œç”¨ï¼ˆè™½ç„¶ç›®çš„ä¸åŒï¼‰ã€‚æ ¹æ®é¢„å®šä¹‰å®çš„ä¸åŒï¼Œç³»ç»Ÿä¼šåœ¨åŒä¸€å¥—ä»£ç ä¸‹é€‰æ‹©ä¸åŒçš„ç¼–ç æ–¹å¼åŠå¯¹åº”çš„å‡½æ•°ã€‚æ‹¿ä¸€ä¸ªæœ€å°çš„ä¾‹å­æ¥è¯´ï¼š
```c++

#include <stdio.h>
#include <tchar.h>
int _tmain(int argc, TCHAR* argv[])
{
  _putts(_T("Hello world!\n"));
}
```
å¦‚æœç”¨ç¼ºçœçš„å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œç¼–è¯‘ï¼Œä¸Šé¢çš„ä»£ç ç›¸å½“äºï¼š
```c++
#include <stdio.h>
int main(int argc, char* argv[])
{
  puts("Hello world!\n");
}
```
è€Œå¦‚æœåœ¨å‘½ä»¤è¡Œä¸ŠåŠ ä¸Šäº† /D_UNICODEï¼Œé‚£ä»£ç åˆ™ç›¸å½“äºï¼š
```c++
#include <stdio.h>
int wmain(int argc, wchar_t* argv[])
{
  _putws(L"Hello world!\n");
}
```
å½“ç„¶ï¼Œè¿™ä¸ªä»£ç è¿˜æ˜¯åªèƒ½åœ¨ Windows ä¸Šç”¨ï¼Œå¹¶ä¸”ä»ç„¶ä¸æ¼‚äº®ï¼ˆæ‰€æœ‰çš„å­—ç¬¦å’Œå­—ç¬¦ä¸²å­—é¢é‡éƒ½å¾—å¥—ä¸Š _Tï¼‰ã€‚åè€…æ— è§£ï¼Œå‰è€…åˆ™å¯ä»¥æ‰¾åˆ°æ›¿ä»£æ–¹æ¡ˆï¼ˆç”šè‡³è‡ªå·±å†™ä¹Ÿä¸å¤æ‚ï¼‰ã€‚C++ REST SDK ä¸­å°±æä¾›äº†ç±»ä¼¼çš„å°è£…ï¼Œå¯ä»¥è·¨å¹³å°åœ°å¼€å‘ç½‘ç»œåº”ç”¨ã€‚ä½†å¯ä»¥è¯´ï¼Œè¿™ç§æ–¹å¼æ˜¯ä¸€ç§ä¸»è¦ç…§é¡¾ Windows çš„å¼€å‘æ–¹å¼ã€‚

ç›¸åº”çš„ï¼Œå¯¹ Unix å¼€å‘è€…è€Œè¨€æ›´è‡ªç„¶çš„æ–¹å¼æ˜¯å…¨é¢ä½¿ç”¨ UTF-8ï¼Œä»…åœ¨è·Ÿæ“ä½œç³»ç»Ÿã€æ–‡ä»¶ç³»ç»Ÿæ‰“äº¤é“æ—¶æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆéœ€è¦çš„ç¼–ç ã€‚åˆ©ç”¨ä¸´æ—¶å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·å†™å¸®åŠ©å‡½æ•°å’Œå®ã€‚
utf8_to_native.hppï¼š
```c++
#ifndef PINE_UTF8_TO_NATIVE_HPP
#define PINE_UTF8_TO_NATIVE_HPP

#include <string>

#if defined(_WIN32) || \
    defined(_UNICODE)

std::wstring utf_8_to_wstring(const char* str);
std::wstring utf_8_to_wstring(const std::string& str);

#define NATIVE_STR(s) \
  utf_8_to_wstring(s).c_str()

#else

inline const char* to_c_str(const char* str) {
  return str;
}

inline const char* to_c_str(const std::string& str) {
  return str.c_str();
}

#define NATIVE_STR(s) \
  to_c_str(s)
#endif

#endif  // PINE_UTF8_TO_NATIVE_HPP
```

utf8_to_native.cppï¼š
```c++

#include "utf8_to_native.hpp"
#if defined(_WIN32) || \
    defined(_UNICODE)
#include <windows.h>
#include <system_error>
namespace {
void throw_system_error(
  const char* reason)
{
  std::string msg(reason);
  msg += " failed";
  std::error_code ec(
    GetLastError(),
    std::system_category());
  throw std::system_error(ec, msg);
}
} /* unnamed namespace */
std::wstring utf8_to_wstring(
  const char* str)
{
  int len = MultiByteToWideChar(
    CP_UTF8, 0, str, -1,
    nullptr, 0);
  if (len == 0) {
    throw_system_error(
      "utf8_to_wstring");
  }
  std::wstring result(len - 1,
                      L'\0');
  if (MultiByteToWideChar(
        CP_UTF8, 0, str, -1,
        result.data(), len) == 0) {
    throw_system_error(
      "utf8_to_wstring");
  }
  return result;
}
std::wstring utf8_to_wstring(
  const std::string& str)
{
  return utf8_to_wstring(
    str.c_str());
}
#endif
```
åœ¨å¤´æ–‡ä»¶é‡Œï¼Œå®šä¹‰äº†åœ¨ Windows ä¸‹ä¼šåš UTF-8 åˆ° UTF-16 çš„è½¬æ¢ï¼›åœ¨å…¶ä»–ç¯å¢ƒä¸‹åˆ™ä¸çœŸæ­£åšè½¬æ¢ï¼Œè€Œæ˜¯ä¸ç®¡æä¾›çš„æ˜¯å­—ç¬¦æŒ‡é’ˆè¿˜æ˜¯ string éƒ½ä¼šè½¬æ¢æˆå­—ç¬¦æŒ‡é’ˆã€‚åœ¨ Windows ä¸‹æ¯æ¬¡è°ƒç”¨ NATIVE_STR ä¼šç”Ÿæˆä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œå½“å‰è¯­å¥æ‰§è¡Œç»“æŸåè¿™ä¸ªä¸´æ—¶å¯¹è±¡ä¼šè‡ªåŠ¨é”€æ¯ã€‚

ä½¿ç”¨è¯¥åŠŸèƒ½çš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š
```c++
#include <fstream>
#include "utf8_to_native.hpp"
int main()
{
  using namespace std;
  const char filename[] =
    u8"æµ‹è¯•.txt";
  ifstream ifs(
    NATIVE_STR(filename));
  //  å¯¹  ifs  è¿›è¡Œæ“ä½œ
ï½
```
ä¸Šé¢è¿™æ ·çš„ä»£ç å¯ä»¥åŒæ—¶é€‚ç”¨äºç°ä»£ Unix å’Œç°ä»£ Windowsï¼ˆä»»ä½•è¯­è¨€è®¾ç½®ä¸‹ï¼‰ï¼Œç”¨æ¥è¯»å–åä¸ºâ€œæµ‹è¯•.txtâ€çš„æ–‡ä»¶ã€‚

### ç¼–ç¨‹æ”¯æŒ
ä»‹ç»ä¸€ä¸‹å…¶ä»–çš„ä¸€äº›æ”¯æŒ Unicode åŠå…¶è½¬æ¢çš„ APIã€‚

#### WINDOWS API
Windows ä¸‹ç”¨åˆ°äº† MultiByteToWideCharï¼Œä»æŸä¸ªç¼–ç è½¬åˆ° UTF-16ã€‚Windows ä¹Ÿæä¾›äº†åå‘çš„ WideCharToMultiByte ï¼Œä» UTF-16 è½¬åˆ°æŸä¸ªç¼–ç ã€‚ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼ŒC æ¥å£ç”¨èµ·æ¥å¹¶ä¸æ–¹ä¾¿ï¼Œå¯ä»¥è€ƒè™‘è‡ªå·±å°è£…ä¸€ä¸‹ã€‚

#### iconv
Unix ä¸‹æœ€å¸¸ç”¨çš„åº•å±‚ç¼–ç è½¬æ¢æ¥å£æ˜¯ iconvï¼Œæä¾› iconv_openã€iconv_close å’Œ iconv ä¸‰ä¸ªå‡½æ•°ã€‚è¿™åŒæ ·æ˜¯ C æ¥å£ï¼Œå®è·µä¸­åº”è¯¥å°è£…ä¸€ä¸‹ã€‚

#### ICU4C
ICU  æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Unicode æ”¯æŒåº“ï¼Œæä¾›å¤§é‡çš„æ–¹æ³•ï¼ŒICU4C æ˜¯å…¶ C/C++ çš„ç‰ˆæœ¬ã€‚ICU æœ‰ä¸“é—¨çš„å­—ç¬¦ä¸²ç±»å‹ï¼Œå†…ç æ˜¯ UTF-16ï¼Œä½†å¯ä»¥ç›´æ¥ç”¨äº IO streams çš„è¾“å‡ºã€‚ä¸‹é¢çš„ç¨‹åºåº”è¯¥åœ¨æ‰€æœ‰å¹³å°ä¸Šéƒ½æœ‰åŒæ ·çš„è¾“å‡ºï¼ˆä½†åœ¨ Windows ä¸Šè¦æ±‚å½“å‰ç³»ç»Ÿä¼ ç»Ÿç¼–ç èƒ½æ”¯æŒå¾…è¾“å‡ºçš„å­—ç¬¦ï¼‰ï¼š
```c++

#include <iostream>
#include <string>
#include <unicode/unistr.h>
#include <unicode/ustream.h>
using namespace std;
using icu::UnicodeString;
int main()
{
  auto str = UnicodeString::fromUTF8(
    u8"ä½ å¥½");
  cout << str << endl;
  string u8str;
  str.toUTF8String(u8str);
  cout << "In UTF-8 it is "
       << u8str.size() << " bytes"
       << endl;
}
```

### codecvt
C++11 æ›¾ç»å¼•å…¥äº†ä¸€ä¸ªå¤´æ–‡ä»¶ <codecvt>  ç”¨ä½œ UTF ç¼–ç é—´çš„è½¬æ¢ï¼Œä½†å¾ˆé—æ†¾ï¼Œé‚£ä¸ªå¤´æ–‡ä»¶ç›®å‰å·²å› ä¸ºå­˜åœ¨å®‰å…¨æ€§å’Œæ˜“ç”¨æ€§é—®é¢˜è¢«å®£å‘Šæ”¾å¼ƒï¼ˆdeprecatedï¼‰ã€‚<locale> ä¸­æœ‰å¦å¤–ä¸€ä¸ª codecvt æ¨¡æ¿ [ï¼Œæœ¬èº«æ¥å£ä¸é‚£ä¹ˆå¥½ç”¨ï¼Œè€Œä¸”åˆ° C++20 è¿˜ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™å„¿ä¹Ÿä¸è¯¦ç»†ä»‹ç»äº†ã€‚æœ‰å…´è¶£çš„è¯å¯ä»¥ç›´æ¥çœ‹å‚è€ƒèµ„æ–™ã€‚